<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智融 WIBO</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 90vh;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      background-color: #f0f2f5;
    }

    .tabs {
      display: flex;
      cursor: pointer;
      border-bottom: 2px solid #ccc;
    }

    .tab {
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-bottom: none;
      background-color: #e0e0e0;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }

    .tab.active {
      background-color: #fff;
      border-bottom: 2px solid #fff;
      font-weight: bold;
    }

    .tab-content {
      display: none;
      border: 1px solid #ccc;
      padding: 20px;
      background-color: #fff;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-top: -1px; /* 去掉tab页与下面交互区域的空隙 */
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    .section h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      background-color: blue;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    .plugin-list {
      list-style-type: none;
      padding: 0;
    }

    .plugin-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
      border-radius: 5px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .plugin-actions button {
      margin-left: 5px;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .plugin-actions button:hover {
      background-color: #0056b3;
    }

    .plugin-section {
      margin-bottom: 20px;
      width: 100%;
    }

    .plugin-column {
      flex: 1;
      padding: 0 10px;
    }

    .plugin-actions {
      display: flex;
      gap: 10px;
    }

    .local-plugins .import-button:hover {
      background-color: #0056b3;
    }

    /* 新增样式 */
    #chat-container {
      width: 80%;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background-color: #f9f9f9;
    }

    #messages {
      height: 400px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 20px;
      background-color: #fff;
    }

    .message {
      margin-bottom: 10px;
    }

    .user {
      text-align: right;
      color: blue;
    }

    .wiba {
      text-align: left;
      color: green;
    }

    #input-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #user-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      resize: none;
      overflow: hidden;
    }

    #input-container select,
    #input-container input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #input-container button {
      padding: 10px 20px;
      border: none;
      background-color: blue;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    .bot pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .bot code {
      font-family: monospace;
      background-color: #f4f4f4;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* 新增样式 */
    .switch {
      position: relative;
      display: inline-block;
      width: 48px; /* 减少20% */
      height: 27px; /* 减少20% */
      vertical-align: middle;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 27px; /* 减少20% */
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 21px; /* 减少20% */
      width: 21px; /* 减少20% */
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:checked + .slider:before {
      transform: translateX(21px); /* 减少20% */
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .input-group input[type="text"] {
      flex: 1;
    }
  </style>
  <!-- 添加 marked 库 -->
  <script src="/js/marked.min.js"></script>
</head>

<body>


  <h1>围脖 WIBO</h1>
  <div class="tabs">
    <div class="tab active" data-tab="interaction">对话</div>
    <div class="tab" data-tab="config">配置</div>
    <div class="tab" data-tab="plugins">插件</div>
  </div>

  <!-- 交互界面内容区域 -->
  <div id="interaction" class="tab-content active">
    <div id="chat-container">
      <h2>围脖（WIBO）你自己的知识助手 </h2>
      <div id="messages"></div>
      <div id="input-container">
        <textarea id="user-input" placeholder="输入你的问题" rows="1"></textarea>
        <div class="input-group">
          <select id="request-type">
            <option value="searchAndChat">检索增强回答</option>
            <option value="search">本地文件检索</option>
            <option value="chat">模型直答</option>
            <option value="searchWithRerank">模型增强排序检索</option>
          </select>
          <label for="foregroundExecution">隐藏浏览器执行</label>
          <label class="switch">
            <input type="checkbox" id="foregroundExecution">
            <span class="slider"></span>
          </label>
          <input type="text" id="pathInput" placeholder="Path (optional)" />
        </div>
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- 配置内容区域 -->
  <div id="config" class="tab-content">
    <div class="section">
      <h3>AK设置</h3>
      <div class="form-group">
        <label for="accessKey">Access Key：</label>
        <input type="text" id="accessKey" class="form-control" placeholder="请输入Access Key" />
      </div>
      <button id="saveConfigButton" class="btn">保存</button>
    </div>
    <div class="section">
      <h3>浏览器设置</h3>
      <div class="form-group">
        <label for="browserTimeout">浏览器超时时间：</label>
        <input type="number" id="browserTimeout" class="form-control" placeholder="请输入浏览器超时时间" />
      </div>
      <div class="form-group">
        <label for="browserConcurrency">并发启动浏览器个数：</label>
        <input type="number" id="browserConcurrency" class="form-control" placeholder="请输入并发启动浏览器个数" />
      </div>
      <div class="form-group">
        <label for="pageFetchLimit">单次查询页面抓取数量：</label>
        <input type="number" id="pageFetchLimit" class="form-control" placeholder="请输入单次查询页面抓取数量" />
      </div>
      <button id="saveBrowserConfigButton" class="btn">保存</button>
    </div>
  </div>

  <!-- 插件内容区域 -->
  <div id="plugins" class="tab-content">
    <div class="section">
      <h3>当前我所有的插件</h3>
      <ul class="plugin-list" id="currentPluginsList">
        <!-- 插件列表将在这里动态显示 -->
      </ul>
    </div>
    <div class="section">
      <h3>插件市场</h3>
      <ul class="plugin-list" id="marketPluginsList">
        <!-- 插件市场列表将在这里动态显示 -->
      </ul>
    </div>
    <div class="section">
      <h3>本地插件新增</h3>
      <button class="import-button btn" id="importLocalPluginButton">从本地导入</button>
    </div>
  </div>

  <script>
    // JavaScript to handle tab switching
    document.querySelectorAll('.tabs .tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const parent = tab.closest('.tab-content') || document;
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        parent.querySelector(`#${tab.dataset.tab}`).classList.add('active');
      });
    });

    // 删除动态生成插件列表的代码

    const config = {
      pageFetchLimit: 10 // 修改后的配置项
    };

    let currentBotMessageElement = null;

    function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value;
      const type = document.getElementById('request-type').value;
      const path = document.getElementById('pathInput').value;
      const foregroundExecution = document.getElementById('foregroundExecution').checked;
      if (!message) return;

      addMessage('user', message);
      input.value = '';
      currentBotMessageElement = createBotMessageElement();

      fetch('/chat/stream', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ input: message, type: type, path: path, foregroundExecution: foregroundExecution })
      })
      .then(response => {
        if (!response.ok) {
          if (response.status === 401) {
            alert('Unauthorized: 请在右上角的 【管理界面】 中输入阿里云的大模型AK');
          }
          throw new Error('Network response was not ok');
        }
        return response.body.getReader();
      })
      .then(reader => {
        const decoder = new TextDecoder();
        let receiveBuffer = [];
        let lastAvailableChunk = [];
        function read() {
          reader.read().then(({ done, value }) => {
            if (done) {
              if (receiveBuffer.length > 0) {
                const finalText = processBuffer(receiveBuffer);
                updateBotMessage(finalText);
              }
              currentBotMessageElement = null;
              return;
            }

            const chunk = decoder.decode(value, { stream: false });
            const lines = chunk.split('\n');
            console.log('a chunk :\n' + chunk);
            for (const line of lines) {
              if (line.trim() === '') {
                receiveBuffer = [];
                continue;
              } else {
                lastAvailableChunk = receiveBuffer;
              }
              receiveBuffer.push(line);
            }

            const text = processBuffer(lastAvailableChunk);
            if (text.trim()) {
              updateBotMessage(text);
            }

            read();
          });
        }

        read();
      })
      .catch(error => {
        console.error('Error:', error);
        updateBotMessage('Error: ' + error.message);
      });
    }

    function addMessage(role, text) {
      const messages = document.getElementById('messages');
      const messageElement = document.createElement('div');
      messageElement.className = `message ${role}`;
      const formattedText = text.replace(/\n/g, '<br>');
      messageElement.innerHTML = formattedText;
      messages.appendChild(messageElement);
      messages.scrollTop = messages.scrollHeight;
      return messageElement;
    }

    function createBotMessageElement() {
      const messages = document.getElementById('messages');
      const messageElement = document.createElement('div');
      messageElement.className = 'message wiba';
      messages.appendChild(messageElement);
      messages.scrollTop = messages.scrollHeight;
      return messageElement;
    }

    function processBuffer(buffer) {
      const rawText = buffer
        .map(line => line.replace('data:', '').trim())
        .filter(line => line)
        .join('\n\n');

      try {
        return marked.parse(rawText, {
          breaks: false,
          gfm: true,
          sanitize: true
        });
      } catch (e) {
        console.error('Markdown parsing error:', e);
        return rawText;
      }
    }

    function updateBotMessage(text) {
      if (currentBotMessageElement) {
        currentBotMessageElement.innerHTML = text;
        currentBotMessageElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
    }

    // 自动调整输入框高度
    const userInput = document.getElementById('user-input');
    userInput.addEventListener('input', () => {
      userInput.style.height = 'auto';
      userInput.style.height = `${Math.min(userInput.scrollHeight, 150)}px`;
    });

    // 绑定保存浏览器设置按钮事件
    document.getElementById('saveBrowserConfigButton').addEventListener('click', handleSaveConfig);
  </script>
</body>

</html>